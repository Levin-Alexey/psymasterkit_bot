from aiogram import Router, F
from aiogram.types import CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from sqlalchemy import select
from loguru import logger
from database import AsyncSessionLocal
from models import User, QuizScenario

consultation_router = Router()


@consultation_router.callback_query(F.data == "ready_for_next_step")
async def handle_ready_for_next_step(callback: CallbackQuery):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ì–æ—Ç–æ–≤(–∞) –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É'.
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è.
    """
    async with AsyncSessionLocal() as db:
        result = await db.execute(
            select(User).where(User.telegram_id == callback.from_user.id)
        )
        user = result.scalar_one_or_none()

    if not user:
        await callback.message.answer("–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        await callback.answer()
        return

    # –ü—Ä–∏–≤–æ–¥–∏–º —Å—Ü–µ–Ω–∞—Ä–∏–π –∫ Enum –µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π
    scenario = user.main_quiz_scenario
    if isinstance(scenario, str):
        try:
            scenario = QuizScenario(scenario)
        except Exception:
            scenario = None

    logger.info(
        f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {callback.from_user.id} –≥–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É. "
        f"–°—Ü–µ–Ω–∞—Ä–∏–π: {scenario}"
    )

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è
    if scenario == QuizScenario.IMPOSTOR:
        text = (
            'üìû <b>–•–æ—Ç–∏—Ç–µ –ø–æ–Ω—è—Ç—å, –∫–∞–∫ "–°—É–ø–µ—Ä–≤–∏–∑–∏—è" –≤—ã–≤–æ–¥–∏—Ç –∏–∑ —Å–∏–Ω–¥—Ä–æ–º–∞ '
            '—Å–∞–º–æ–∑–≤–∞–Ω—Ü–∞ –≤ —Å—Ç–∞–±–∏–ª—å–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É?</b>\n\n'
            "–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.\n\n"
            "–ù–∞ –∑–≤–æ–Ω–∫–µ –≤—ã:\n"
            '‚Üí –£–∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≤–æ–ø—Ä–æ—Å "–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —è '
            '–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω"\n'
            '‚Üí –ü–æ–π–º—ë—Ç–µ, –∫–∞–∫ –Ω–∞—á–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ —Å—Ç—Ä–∞—Ö–∞ "–Ω–∞–≤—Ä–µ–¥–∏—Ç—å"\n'
            "‚Üí –ü–æ–ª—É—á–∏—Ç–µ –ø–ª–∞–Ω: –∫–∞–∫ –ø–æ–¥–Ω—è—Ç—å —Ü–µ–Ω—É –∏ –ø–µ—Ä–µ—Å—Ç–∞—Ç—å –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞—Ç—å "
            "—Å–≤–æ–π –æ–ø—ã—Ç\n\n"
            "<b>–≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ.</b>"
        )
    elif scenario == QuizScenario.ETERNAL_STUDENT:
        text = (
            'üìû <b>–•–æ—Ç–∏—Ç–µ –ø–æ–Ω—è—Ç—å, –∫–∞–∫ "–°—É–ø–µ—Ä–≤–∏–∑–∏—è" –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç '
            '–ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º –∏–∑ —Ç–æ—Ä–º–æ–∑–∞ –≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç?</b>\n\n'
            "–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.\n\n"
            "–ù–∞ –∑–≤–æ–Ω–∫–µ –≤—ã:\n"
            "‚Üí –£–∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤—ã–≤–æ–¥–∏—Ç –≤–∞—Å –≤ –ø—Ä–∞–∫—Ç–∏–∫—É —É–∂–µ —Å –ø–µ—Ä–≤–æ–≥–æ "
            "–º–µ—Å—è—Ü–∞\n"
            "‚Üí –ü–æ–π–º—ë—Ç–µ, –∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –≥–æ—Ç–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–∞–±–æ—Ç—ã\n"
            "‚Üí –ü–æ–ª—É—á–∏—Ç–µ –ø–ª–∞–Ω: –∫–∞–∫ –Ω–∞—á–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å, –Ω–µ —Ç–µ—Ä—è—è "
            "–∫–∞—á–µ—Å—Ç–≤–∞\n\n"
            "<b>–≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ  –º–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ.</b>"
        )
    elif scenario == QuizScenario.SEEKER:
        text = (
            'üìû <b>–•–æ—Ç–∏—Ç–µ –ø–æ–Ω—è—Ç—å, –∫–∞–∫ "–°—É–ø–µ—Ä–≤–∏–∑–∏—è" –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π '
            '–ø–æ–∏—Å–∫ –≤ —á—ë—Ç–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ?</b>\n\n'
            "–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.\n\n"
            "–ù–∞ –∑–≤–æ–Ω–∫–µ –≤—ã:\n"
            "‚Üí –£–∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –¥–∞—ë—Ç –æ–¥–∏–Ω –≥–ª—É–±–æ–∫–∏–π –ø–æ–¥—Ö–æ–¥ –≤–º–µ—Å—Ç–æ "
            "–º–µ—Ç–∞–Ω–∏–π –º–µ–∂–¥—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏\n"
            "‚Üí –ü–æ–π–º—ë—Ç–µ, –∫–∞–∫ –ø—Ä–∞–∫—Ç–∏–∫–∞ —Å –ø–µ—Ä–≤—ã—Ö –Ω–µ–¥–µ–ª—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–º–Ω–µ–Ω–∏—è "
            "–±—ã—Å—Ç—Ä–µ–µ –ª—é–±–æ–π —Ç–µ–æ—Ä–∏–∏\n"
            "‚Üí –ü–æ–ª—É—á–∏—Ç–µ –ø–ª–∞–Ω: –∫–∞–∫ –æ–±—Ä–µ—Å—Ç–∏ —è—Å–Ω–æ—Å—Ç—å –∏ –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–∞ "
            "–ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏\n\n"
            "<b>–≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ.</b>"
        )
    else:
        # Fallback –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω
        text = (
            'üìû <b>–•–æ—Ç–∏—Ç–µ –ø–æ–Ω—è—Ç—å, –∫–∞–∫ "–°—É–ø–µ—Ä–≤–∏–∑–∏—è" –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –≤—ã–π—Ç–∏ '
            '–Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É?</b>\n\n'
            "–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.\n\n"
            "<b>–≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ.</b>"
        )

    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É",
                    callback_data="book_consultation"
                )
            ]
        ]
    )

    await callback.message.answer(text, parse_mode="HTML", reply_markup=keyboard)
    await callback.answer()
