from aiogram import Router, F
from aiogram.types import CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from sqlalchemy import select
from loguru import logger
from database import AsyncSessionLocal
from models import User, QuizScenario
from analytics import log_event

consultation_router = Router()


@consultation_router.callback_query(F.data == "ready_for_next_step")
async def handle_ready_for_next_step(callback: CallbackQuery):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ì–æ—Ç–æ–≤(–∞) –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É'.
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è.
    """
    async with AsyncSessionLocal() as db:
        result = await db.execute(
            select(User).where(User.telegram_id == callback.from_user.id)
        )
        user = result.scalar_one_or_none()

    if not user:
        await callback.message.answer("–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        await callback.answer()
        return

    # –ü—Ä–∏–≤–æ–¥–∏–º —Å—Ü–µ–Ω–∞—Ä–∏–π –∫ Enum –µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π
    scenario = user.main_quiz_scenario
    if isinstance(scenario, str):
        try:
            scenario = QuizScenario(scenario)
        except Exception:
            scenario = None

    logger.info(
        f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {callback.from_user.id} –≥–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É. "
        f"–°—Ü–µ–Ω–∞—Ä–∏–π: {scenario}"
    )

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è
    if scenario == QuizScenario.IMPOSTOR:
        text = (
            'üìû <b>–•–æ—Ç–∏—Ç–µ –ø–æ–Ω—è—Ç—å, –∫–∞–∫ "–°—É–ø–µ—Ä–≤–∏–∑–∏—è" –≤—ã–≤–æ–¥–∏—Ç –∏–∑ —Å–∏–Ω–¥—Ä–æ–º–∞ '
            '—Å–∞–º–æ–∑–≤–∞–Ω—Ü–∞ –≤ —Å—Ç–∞–±–∏–ª—å–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É?</b>\n\n'
            "–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.\n\n"
            "–ù–∞ –∑–≤–æ–Ω–∫–µ –≤—ã:\n"
            '‚Üí –£–∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≤–æ–ø—Ä–æ—Å "–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —è '
            '–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω"\n'
            '‚Üí –ü–æ–π–º—ë—Ç–µ, –∫–∞–∫ –Ω–∞—á–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ —Å—Ç—Ä–∞—Ö–∞ "–Ω–∞–≤—Ä–µ–¥–∏—Ç—å"\n'
            "‚Üí –ü–æ–ª—É—á–∏—Ç–µ –ø–ª–∞–Ω: –∫–∞–∫ –ø–æ–¥–Ω—è—Ç—å —Ü–µ–Ω—É –∏ –ø–µ—Ä–µ—Å—Ç–∞—Ç—å –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞—Ç—å "
            "—Å–≤–æ–π –æ–ø—ã—Ç\n\n"
            "<b>–≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ.</b>"
        )
    elif scenario == QuizScenario.ETERNAL_STUDENT:
        text = (
            'üìû <b>–•–æ—Ç–∏—Ç–µ –ø–æ–Ω—è—Ç—å, –∫–∞–∫ "–°—É–ø–µ—Ä–≤–∏–∑–∏—è" –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç '
            '–ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º –∏–∑ —Ç–æ—Ä–º–æ–∑–∞ –≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç?</b>\n\n'
            "–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.\n\n"
            "–ù–∞ –∑–≤–æ–Ω–∫–µ –≤—ã:\n"
            "‚Üí –£–∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤—ã–≤–æ–¥–∏—Ç –≤–∞—Å –≤ –ø—Ä–∞–∫—Ç–∏–∫—É —É–∂–µ —Å –ø–µ—Ä–≤–æ–≥–æ "
            "–º–µ—Å—è—Ü–∞\n"
            "‚Üí –ü–æ–π–º—ë—Ç–µ, –∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –≥–æ—Ç–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–∞–±–æ—Ç—ã\n"
            "‚Üí –ü–æ–ª—É—á–∏—Ç–µ –ø–ª–∞–Ω: –∫–∞–∫ –Ω–∞—á–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å, –Ω–µ —Ç–µ—Ä—è—è "
            "–∫–∞—á–µ—Å—Ç–≤–∞\n\n"
            "<b>–≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ  –º–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ.</b>"
        )
    elif scenario == QuizScenario.SEEKER:
        text = (
            'üìû <b>–•–æ—Ç–∏—Ç–µ –ø–æ–Ω—è—Ç—å, –∫–∞–∫ "–°—É–ø–µ—Ä–≤–∏–∑–∏—è" –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π '
            '–ø–æ–∏—Å–∫ –≤ —á—ë—Ç–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ?</b>\n\n'
            "–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.\n\n"
            "–ù–∞ –∑–≤–æ–Ω–∫–µ –≤—ã:\n"
            "‚Üí –£–∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –¥–∞—ë—Ç –æ–¥–∏–Ω –≥–ª—É–±–æ–∫–∏–π –ø–æ–¥—Ö–æ–¥ –≤–º–µ—Å—Ç–æ "
            "–º–µ—Ç–∞–Ω–∏–π –º–µ–∂–¥—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏\n"
            "‚Üí –ü–æ–π–º—ë—Ç–µ, –∫–∞–∫ –ø—Ä–∞–∫—Ç–∏–∫–∞ —Å –ø–µ—Ä–≤—ã—Ö –Ω–µ–¥–µ–ª—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–º–Ω–µ–Ω–∏—è "
            "–±—ã—Å—Ç—Ä–µ–µ –ª—é–±–æ–π —Ç–µ–æ—Ä–∏–∏\n"
            "‚Üí –ü–æ–ª—É—á–∏—Ç–µ –ø–ª–∞–Ω: –∫–∞–∫ –æ–±—Ä–µ—Å—Ç–∏ —è—Å–Ω–æ—Å—Ç—å –∏ –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–∞ "
            "–ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏\n\n"
            "<b>–≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ.</b>"
        )
    else:
        # Fallback –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω
        text = (
            'üìû <b>–•–æ—Ç–∏—Ç–µ –ø–æ–Ω—è—Ç—å, –∫–∞–∫ "–°—É–ø–µ—Ä–≤–∏–∑–∏—è" –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –≤—ã–π—Ç–∏ '
            '–Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É?</b>\n\n'
            "–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.\n\n"
            "<b>–≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ.</b>"
        )

    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É",
                    callback_data="book_consultation"
                )
            ]
        ]
    )

    await callback.message.answer_photo(photo="https://iimg.su/i/qZGxoI")
    await callback.message.answer(text, parse_mode="HTML", reply_markup=keyboard)
    await callback.answer()


@consultation_router.callback_query(F.data == "book_consultation")
async def handle_book_consultation(callback: CallbackQuery):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É'. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–ª–æ–∫ –ø—Ä–æ —Å–æ–º–Ω–µ–Ω–∏—è
    –∏ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.
    """
    text = (
        "<b>–°–æ–º–Ω–µ–≤–∞–µ—Ç–µ—Å—å, —Å—Ç–æ–∏—Ç –ª–∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É?</b>\n\n"
        "–≠—Ç–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ. –ö–æ–≥–¥–∞ –Ω–∞ –∫–æ–Ω—É —Å–µ—Ä—å—ë–∑–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∂–∏–∑–Ω–∏, "
        "–∑–¥–æ—Ä–æ–≤—ã–π —Å–∫–µ–ø—Ç–∏—Ü–∏–∑–º ‚Äî —ç—Ç–æ –Ω–µ —Å–ª–∞–±–æ—Å—Ç—å, –∞ –º—É–¥—Ä–æ—Å—Ç—å.\n\n"
        "–í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –¥—É–º–∞–µ—Ç–µ: \"–ê –≤–¥—Ä—É–≥ —ç—Ç–æ –æ—á–µ—Ä–µ–¥–Ω—ã–µ –ø—É—Å—Ç—ã–µ –æ–±–µ—â–∞–Ω–∏—è? –ê –≤–¥—Ä—É–≥ —è "
        "–ø–æ—Ç—Ä–∞—á—É –≤—Ä–µ–º—è –≤–ø—É—Å—Ç—É—é? –ê –≤–¥—Ä—É–≥ —É –º–µ–Ω—è –æ—Å–æ–±—ã–π —Å–ª—É—á–∞–π, –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–∂–µ—Ç?\"\n\n"
        "–ú—ã –ø–æ–Ω–∏–º–∞–µ–º —ç—Ç–∏ —Å–æ–º–Ω–µ–Ω–∏—è, –±–æ–ª–µ–µ —Ç–æ–≥–æ ‚Äî –º—ã –∏—Ö —Ä–∞–∑–¥–µ–ª—è–µ–º.\n"
        "–ò–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É –Ω–µ –ø—Ä–æ—Å–∏–º –≤–µ—Ä–∏—Ç—å –∫—Ä–∞—Å–∏–≤—ã–º —Å–ª–æ–≤–∞–º.\n\n"
        "<b>–í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —É–≤–∏–¥–µ—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ \"–°—É–ø–µ—Ä–≤–∏–∑–∏–∏\" ‚Äî "
        "—Å –∏—Ö –Ω–∞—Å—Ç–æ—è—â–∏–º–∏ –ø—Ä–æ–±–ª–µ–º–∞–º–∏, —Å–æ–º–Ω–µ–Ω–∏—è–º–∏ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã.</b>\n\n"
        "–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –∫–∞–∫ –ª—é–¥–∏ —Å —Ç–æ—á–Ω–æ —Ç–∞–∫–∏–º–∏ –∂–µ –±–ª–æ–∫–∞–º–∏ –∏ —Å—Ç—Ä–∞—Ö–∞–º–∏ –Ω–∞—Ö–æ–¥–∏–ª–∏ –≤—ã—Ö–æ–¥. "
        "–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–Ω—è—Ç—å: –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ —ç—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –º–æ–∂–µ—Ç —Å—Ä–∞–±–æ—Ç–∞—Ç—å –∏–º–µ–Ω–Ω–æ –¥–ª—è –≤–∞—Å."
    )

    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤",
                    callback_data="view_participant_results"
                )
            ]
        ]
    )

    await callback.message.answer(text, parse_mode="HTML", reply_markup=keyboard)
    await callback.answer()
    # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É'
    await log_event(
        user_telegram_id=callback.from_user.id,
        event_code="book_consultation_clicked",
    )


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ 'view_participant_results' –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω –≤ handlers/results_handler.py
